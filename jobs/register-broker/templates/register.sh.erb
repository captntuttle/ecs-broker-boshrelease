#!/bin/bash
set -e -x

export SCHEME=https
export PATH="/var/vcap/packages/cf_cli/bin:$PATH"
export ADMIN_USER=<%= properties.generic_sb.cf.admin_user %>
export ADMIN_PASSWORD=<%= properties.generic_sb.cf.admin_password %>
export DOMAIN=<%= properties.domain %>
export API_ENDPOINT=$SCHEME://api.$DOMAIN
export APP_NAME=<%= properties.generic_sb.app_name %>
export ORG=generic-sb-service
export SPACE=generic-sb-service
export BROKER_NAME=app-generic-service-broker
export BROKER_USER=<%= properties.generic_sb.broker.user %>
export BROKER_PASS=<%= properties.generic_sb.broker.password %>
export APP_DOMAIN=<%= properties.app_domains[0] %>
export BROKER_HOST=$SCHEME://${APP_NAME}.${APP_DOMAIN}

function authenticate_and_target() {
  cf api $API_ENDPOINT <% if properties.ssl.skip_cert_verify %>--skip-ssl-validation<% end %>
  cf auth $ADMIN_USER $ADMIN_PASSWORD
  cf create-org $ORG
  cf target -o $ORG
  cf create-space $SPACE
  cf target -s $SPACE
}

function register_broker() {
  broker=`cf service-brokers | grep $BROKER_NAME || true`
  if [[ -z "$broker" ]]; then
    cf create-service-broker $BROKER_NAME $BROKER_USER $BROKER_PASS $BROKER_HOST
  else
    cf update-service-broker $BROKER_NAME $BROKER_USER $BROKER_PASS $BROKER_HOST
  fi
}

function publicize_plans() {
  plans_url=`cf curl /v2/services?q=label:$BROKER_NAME | grep service_plans_url | awk '{ print $2 }' | sed 's/[",]//g'`
  plans=`cf curl $plans_url | grep "\"url\"" | awk '{ print $2 }' | sed 's/[",]//g'`
  for plan in $plans; do
    publicize_plan $plan
  done
}

function publicize_plan() {
  plan_url=$1
  cf curl $plan_url -X PUT -d '{"public": true}'
}

cf -v
authenticate_and_target
register_broker
publicize_plans
